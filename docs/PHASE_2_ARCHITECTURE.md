# AuthorStack Phase 2 Architecture

**Status:** Implementation Complete  
**Version:** Phase 2.0  
**Date:** November 23, 2025

---

## Overview

Phase 2 extends the AuthorStack MVP with analytics, funnel tracking, and rule-based pricing features. All additions are **backward-compatible** with Phase 1 and do not modify existing functionality.

**Phase 2 Features:**
1. **Book Analytics (Basic)** - Aggregate sales data by day/week/month with chart visualizations
2. **Revenue Charts** - Total revenue, per-book breakdowns, and trend analysis
3. **Reader Funnel Basics** - Manual tracking of impressions → clicks → conversions
4. **Pricing Helper (Rule-Based)** - Price optimization suggestions based on historical data

---

## Database Schema Extensions

### New Tables

#### `book_analytics_daily`
Pre-aggregated daily sales data per book and platform for fast queries.

```sql
CREATE TABLE book_analytics_daily (
  id UUID PRIMARY KEY,
  profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  book_id UUID REFERENCES books(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  revenue NUMERIC(12,2) DEFAULT 0,
  units_sold INTEGER DEFAULT 0,
  platform TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (book_id, date, platform)
);

CREATE INDEX book_analytics_daily_book_idx ON book_analytics_daily (book_id, date DESC);
CREATE INDEX book_analytics_daily_profile_idx ON book_analytics_daily (profile_id, date DESC);
```

**Purpose:** Avoid scanning all `sales_events` for date-range queries.

---

#### `funnel_events`
Manual tracking of marketing funnel stages.

```sql
CREATE TABLE funnel_events (
  id UUID PRIMARY KEY,
  profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  book_id UUID REFERENCES books(id) ON DELETE SET NULL,
  event_type TEXT CHECK (event_type IN ('impression', 'click', 'conversion')),
  source TEXT NOT NULL, -- e.g., 'facebook_ad', 'email_campaign'
  metadata JSONB DEFAULT '{}',
  occurred_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX funnel_events_profile_idx ON funnel_events (profile_id, occurred_at DESC);
CREATE INDEX funnel_events_book_idx ON funnel_events (book_id, event_type, occurred_at);
```

**Phase 2:** Manual entry via API.  
**Phase 3+:** Automated tracking via pixels, webhooks, UTM parameters.

---

#### `pricing_snapshots`
Historical price tracking for each book by platform.

```sql
CREATE TABLE pricing_snapshots (
  id UUID PRIMARY KEY,
  profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  book_id UUID REFERENCES books(id) ON DELETE CASCADE,
  platform TEXT NOT NULL,
  price NUMERIC(10,2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  snapshot_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX pricing_snapshots_book_idx ON pricing_snapshots (book_id, snapshot_date DESC);
```

**Purpose:** Enable price change impact analysis.

---

#### `pricing_recommendations`
Cached pricing suggestions generated by rule engine.

```sql
CREATE TABLE pricing_recommendations (
  id UUID PRIMARY KEY,
  profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  book_id UUID REFERENCES books(id) ON DELETE CASCADE,
  recommendation_type TEXT CHECK (recommendation_type IN ('increase', 'decrease', 'revert', 'maintain')),
  suggested_price NUMERIC(10,2),
  reasoning TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours')
);

CREATE INDEX pricing_recommendations_book_idx ON pricing_recommendations (book_id, generated_at DESC);
```

**Expiration:** Recommendations auto-expire after 24 hours to stay fresh.

---

### Views

#### `book_analytics_weekly`
```sql
CREATE VIEW book_analytics_weekly AS
SELECT 
  book_id, profile_id, platform,
  DATE_TRUNC('week', date) AS week_start,
  SUM(revenue) AS revenue,
  SUM(units_sold) AS units_sold
FROM book_analytics_daily
GROUP BY book_id, profile_id, platform, week_start;
```

#### `book_analytics_monthly`
```sql
CREATE VIEW book_analytics_monthly AS
SELECT 
  book_id, profile_id, platform,
  DATE_TRUNC('month', date) AS month_start,
  SUM(revenue) AS revenue,
  SUM(units_sold) AS units_sold
FROM book_analytics_daily
GROUP BY book_id, profile_id, platform, month_start;
```

#### `funnel_conversion_summary`
```sql
CREATE VIEW funnel_conversion_summary AS
SELECT
  profile_id, book_id, source,
  COUNT(*) FILTER (WHERE event_type = 'impression') AS impressions,
  COUNT(*) FILTER (WHERE event_type = 'click') AS clicks,
  COUNT(*) FILTER (WHERE event_type = 'conversion') AS conversions,
  CASE WHEN COUNT(*) FILTER (WHERE event_type = 'impression') > 0
    THEN (COUNT(*) FILTER (WHERE event_type = 'click')::NUMERIC / COUNT(*) FILTER (WHERE event_type = 'impression')) * 100
    ELSE 0 END AS click_through_rate,
  CASE WHEN COUNT(*) FILTER (WHERE event_type = 'click') > 0
    THEN (COUNT(*) FILTER (WHERE event_type = 'conversion')::NUMERIC / COUNT(*) FILTER (WHERE event_type = 'click')) * 100
    ELSE 0 END AS conversion_rate
FROM funnel_events
GROUP BY profile_id, book_id, source;
```

---

## API Endpoints

### `GET /api/analytics`

Fetch book analytics with filtering.

**Query Parameters:**
- `bookId` (optional) - Filter by specific book UUID
- `startDate` (optional) - ISO date string
- `endDate` (optional) - ISO date string
- `granularity` (optional) - `daily` | `weekly` | `monthly` (default: `daily`)
- `platform` (optional) - Filter by platform

**Response:**
```json
{
  "data": [
    { "book_id": "...", "platform": "amazon_kdp", "date": "2025-11-01", "revenue": 123.45, "units_sold": 10 }
  ],
  "summary": {
    "totalRevenue": 1234.56,
    "totalUnits": 100,
    "avgRevenuePerDay": 41.15,
    "dataPoints": 30
  }
}
```

---

### `GET /api/funnel`

Fetch funnel conversion data.

**Query Parameters:**
- `bookId` (optional)
- `source` (optional) - e.g., `facebook_ad`
- `startDate` (optional)
- `endDate` (optional)

**Response:**
```json
{
  "data": [
    { "profile_id": "...", "book_id": "...", "source": "facebook_ad", "impressions": 1000, "clicks": 50, "conversions": 5, "click_through_rate": 5.0, "conversion_rate": 10.0 }
  ],
  "totals": {
    "impressions": 5000,
    "clicks": 250,
    "conversions": 25,
    "clickThroughRate": 5.0,
    "conversionRate": 10.0
  }
}
```

---

### `POST /api/funnel`

Record a funnel event (manual tracking).

**Request Body:**
```json
{
  "bookId": "uuid", // optional
  "eventType": "impression" | "click" | "conversion",
  "source": "facebook_ad",
  "metadata": { "campaign": "launch_week" } // optional
}
```

**Response:**
```json
{ "success": true }
```

---

### `GET /api/pricing`

Fetch pricing recommendations for a book.

**Query Parameters:**
- `bookId` (required)

**Response:**
```json
{
  "recommendations": [
    {
      "id": "...",
      "bookId": "...",
      "recommendationType": "increase",
      "suggestedPrice": 12.99,
      "reasoning": "Your price ($9.99) is significantly below category average ($12.99). Consider increasing to capture more value.",
      "metadata": { "categoryAverage": 12.99, "currentPrice": 9.99 },
      "generatedAt": "2025-11-23T12:00:00Z"
    }
  ]
}
```

**Auto-generation:** If no recommendations exist, the endpoint generates them using the rule engine.

---

## Service Layer

### `AnalyticsService`

**Location:** `lib/modules/analytics/application/analytics-service.ts`

**Methods:**
- `getBookAnalytics(profileId, options)` - Fetch analytics with date/granularity filters
- `getBookRevenueBreakdown(profileId, options)` - Per-book revenue aggregation

**Example:**
```typescript
const analyticsService = new AnalyticsService();
const { data, summary } = await analyticsService.getBookAnalytics(userId, {
  bookId: "...",
  startDate: new Date("2025-11-01"),
  endDate: new Date("2025-11-30"),
  granularity: "daily"
});
```

---

### `FunnelService`

**Methods:**
- `getFunnelData(profileId, options)` - Fetch funnel metrics
- `recordFunnelEvent(profileId, event)` - Record impression/click/conversion

**Example:**
```typescript
const funnelService = new FunnelService();
await funnelService.recordFunnelEvent(userId, {
  bookId: "...",
  eventType: "impression",
  source: "facebook_ad"
});
```

---

### `PricingService`

**Methods:**
- `getPricingRecommendations(profileId, bookId)` - Fetch or generate recommendations
- `recordPricingSnapshot(profileId, snapshot)` - Log price changes

**Example:**
```typescript
const pricingService = new PricingService();
const recommendations = await pricingService.getPricingRecommendations(userId, bookId);
```

---

## UI Components

### `BookAnalyticsChart`

**Location:** `components/analytics/book-analytics-chart.tsx`

**Props:**
- `data` - Array of `{ date, revenue, units }`
- `bookTitle` (optional)
- `granularity` (optional)
- `onGranularityChange` (optional)

**Features:**
- Toggle between revenue/units metrics
- Supports daily/weekly/monthly granularity
- Empty state for new users

---

### `BookRevenueBreakdown`

**Location:** `components/analytics/book-revenue-breakdown.tsx`

**Props:**
- `books` - Array of `{ bookId, bookTitle, revenue, units }`

**Features:**
- Bar chart visualization
- Top 10 books by revenue
- Summary stats below chart

---

### `FunnelVisualization`

**Location:** `components/analytics/funnel-visualization.tsx`

**Props:**
- `data` - `{ impressions, clicks, conversions, clickThroughRate, conversionRate }`
- `onAddEvent` (optional) - Callback for manual entry

**Features:**
- Visual funnel with width proportional to conversion
- CTR and CR percentages
- Empty state with instructions

---

### `PricingSuggestions`

**Location:** `components/analytics/pricing-suggestions.tsx`

**Props:**
- `recommendations` - Array of pricing recommendations
- `currentPrice` (optional)
- `bookTitle` (optional)

**Features:**
- Color-coded by recommendation type (increase/decrease/revert/maintain)
- Reasoning + metadata display
- Empty state for no data

---

### `DateRangePicker`

**Location:** `components/analytics/date-range-picker.tsx`

**Props:**
- `startDate`, `endDate`
- `onRangeChange` - Callback with new dates

**Features:**
- Native HTML date inputs (simple, accessible)
- Reset functionality

---

## Dashboard Pages

### `/dashboard/analytics`

**Features:**
- Summary stats (total revenue, units, avg/day)
- Aggregated analytics chart (all books)
- Per-book revenue breakdown
- Date range filtering (coming soon)

---

### `/dashboard/funnel`

**Features:**
- Funnel visualization with conversion metrics
- Instructions for manual tracking
- API examples

---

### `/dashboard/books/[bookId]/pricing`

**Features:**
- Book-specific analytics chart
- Pricing recommendations
- Strategy tips

---

## Pricing Rule Engine

### Current Rules (Phase 2)

#### Rule 1: Sales Drop After Price Change
- **Trigger:** Revenue drops >30% after recent price increase
- **Recommendation:** Revert to previous price
- **Data:** Compare sales before/after latest pricing snapshot

#### Rule 2: Below Category Average
- **Trigger:** Current price < 80% of category average
- **Recommendation:** Increase to category average
- **Data:** Placeholder (requires competitor data integration in Phase 3)

#### Rule 3: Maintain Optimal
- **Trigger:** No red flags detected
- **Recommendation:** Keep current price
- **Reasoning:** Stable performance

### Recommendation Lifecycle
1. Generated on-demand via `/api/pricing`
2. Cached in `pricing_recommendations` table
3. Auto-expire after 24 hours
4. Cleanup function: `cleanup_expired_pricing_recommendations()`

---

## Migration & Deployment

### Running Migration

```bash
pnpm supabase:start
pnpm db:reset  # Applies 0004_phase2_analytics.sql
```

### Backward Compatibility

✅ All Phase 1 tables unchanged  
✅ New tables use `IF NOT EXISTS`  
✅ No breaking changes to existing API endpoints  
✅ Phase 1 features fully functional

---

## Data Population Strategy

### Analytics Aggregation

**Manual (Initial):**
```sql
INSERT INTO book_analytics_daily (profile_id, book_id, date, revenue, units_sold, platform)
SELECT 
  profile_id, book_id, 
  DATE(occurred_at) AS date,
  SUM(amount) AS revenue,
  SUM(quantity) AS units_sold,
  platform
FROM sales_events
GROUP BY profile_id, book_id, DATE(occurred_at), platform;
```

**Automated (Phase 3):**
- Trigger on `sales_events` insert
- Nightly aggregation job via QStash

---

## Testing Checklist

- [ ] Run `pnpm db:reset` without errors
- [ ] Verify all views return correct data
- [ ] Test `/api/analytics` with various filters
- [ ] Test `/api/funnel` POST and GET
- [ ] Test `/api/pricing` recommendation generation
- [ ] Render `/dashboard/analytics` with empty state
- [ ] Render `/dashboard/funnel` with empty state
- [ ] Render `/dashboard/books/[bookId]/pricing`
- [ ] Verify backward compatibility (Phase 1 pages work)

---

## Phase 3+ Enhancements (Not Implemented)

### Analytics
- Real-time dashboard updates via WebSockets
- Export analytics to CSV/PDF
- Custom date range picker with presets (7d, 30d, 90d, YTD)
- Per-platform revenue comparison charts
- Cohort analysis (launch week vs. steady state)

### Funnel
- Automated tracking via tracking pixels
- UTM parameter ingestion
- Webhook integrations (Facebook Ads, Google Analytics)
- Multi-touch attribution
- Funnel replay (view event sequence per user)

### Pricing
- A/B testing framework (test price A vs. B)
- Dynamic pricing (adjust based on demand, time of day)
- Competitor price monitoring (scrape Amazon, Gumroad)
- Price elasticity modeling (ML-based)
- Revenue optimization simulator

### General
- Push notifications for pricing alerts
- Slack/Discord integrations for funnel milestones
- Mobile app for analytics on-the-go

---

## Critical Implementation Notes

### Performance Considerations

1. **Analytics Queries:** Always query from aggregated tables (`book_analytics_daily/weekly/monthly`), not `sales_events` directly for date ranges.
2. **Pricing Recommendations:** Cache aggressively (24hr TTL). Regenerate only on user request or price change.
3. **Funnel Events:** Index on `profile_id, occurred_at` for fast time-range queries.

### Data Integrity

- **Orphaned Data:** `book_id` is nullable in `funnel_events` (book may be deleted)
- **Currency:** All Phase 2 features assume USD. Multi-currency support in Phase 3.
- **Timezone:** All timestamps use UTC.

### Error Handling

- API endpoints return 400 for invalid params (Zod validation)
- Empty states rendered for new users (no data yet)
- Graceful fallbacks if views return no rows

---

## Service Exports

Update `lib/services.ts`:

```typescript
import { AnalyticsService, FunnelService, PricingService } from "./modules/analytics/application/analytics-service";

const analyticsService = new AnalyticsService();
const funnelService = new FunnelService();
const pricingService = new PricingService();

export const services = {
  // ... existing services
  analytics: analyticsService,
  funnel: funnelService,
  pricing: pricingService,
};
```

---

## Summary

Phase 2 successfully adds:
- ✅ Pre-aggregated analytics tables with views
- ✅ Manual funnel tracking infrastructure
- ✅ Rule-based pricing engine
- ✅ 3 new dashboard pages
- ✅ 5 reusable chart/visualization components
- ✅ 3 new API endpoints
- ✅ Service layer abstractions
- ✅ Full backward compatibility with Phase 1

**Next Steps:**
1. Run migration: `pnpm db:reset`
2. Seed test data for analytics and funnel
3. Test all new pages and API endpoints
4. Update navigation menu to include `/dashboard/analytics` and `/dashboard/funnel`
5. Plan Phase 3 automation features

---

**End of Phase 2 Architecture Document**
